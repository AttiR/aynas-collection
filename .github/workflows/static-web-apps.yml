name: Deploy Frontend to Azure Storage Static Website

on:
  # Disabled - using Azure Static Web Apps instead
  # push:
  #   branches: [ main ]
  #   paths:
  #     - 'frontend/**'
  workflow_dispatch:

jobs:
  build_and_deploy_job:
    runs-on: ubuntu-latest
    name: Build and Deploy Frontend Job
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: true

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Build frontend
        run: |
          cd frontend
          npm run build

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Azure Storage Static Website
        run: |
          # Create storage account if it doesn't exist
          az storage account create \
            --name aynascollectionfrontend \
            --resource-group aynas-collection-rg \
            --location westeurope \
            --sku Standard_LRS \
            --kind StorageV2 \
            --https-only true \
            --min-tls-version TLS1_2

          # Enable static website hosting
          az storage blob service-properties update \
            --account-name aynascollectionfrontend \
            --static-website \
            --index-document index.html \
            --404-document index.html

          # Get the storage account key
          STORAGE_KEY=$(az storage account keys list --account-name aynascollectionfrontend --resource-group aynas-collection-rg --query '[0].value' -o tsv)

          # Upload the built files
          az storage blob upload-batch \
            --account-name aynascollectionfrontend \
            --account-key $STORAGE_KEY \
            --source frontend/build \
            --destination '$web' \
            --overwrite

          # Get the static website URL
          STATIC_URL=$(az storage account show --name aynascollectionfrontend --resource-group aynas-collection-rg --query 'primaryEndpoints.web' -o tsv)
          echo "Frontend deployed to: $STATIC_URL"
